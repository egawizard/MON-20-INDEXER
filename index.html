<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monscription Indexer — Monad Testnet</title>
  <meta name="description" content="Real-time indexer untuk Monscription di Monad Testnet. Menampilkan token, progres mint, holders, dan stream inscribe event">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%230af'%3E%3C/circle%3E%3Ctext x='50' y='58' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EM%3C/text%3E%3C/svg%3E" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icon -->
  <script src="https://unpkg.com/lucide@0.456.0/dist/umd/lucide.min.js"></script>
  <!-- Ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Day.js for time formatting -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script>dayjs.extend(window.dayjs_plugin_relativeTime)</script>
  <style>
    :root { color-scheme: dark; }
    html { scroll-behavior: smooth; }
    /* Luxury glassmorphism */
    .glass { background: rgba(13,17,23,.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.08) }
    .card { border-radius: 1.25rem }
    .gradient-text {
      background: linear-gradient(135deg,#8b5cf6 0%, #06b6d4 50%, #22c55e 100%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .btn { border-radius: 9999px; }
    .btn-primary { background: linear-gradient(135deg,#06b6d4,#3b82f6); }
    .btn-primary:hover { filter: brightness(1.1) }
    .badge { border:1px solid rgba(255,255,255,.1) }
    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.06) 25%, rgba(255,255,255,.12) 37%, rgba(255,255,255,.06) 63%); background-size: 400% 100%; animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:0 0} }
    .table-fixed { table-layout: fixed }
    /* Tooltip */
    .tooltip { position:relative }
    .tooltip:hover::after { content: attr(data-tip); position:absolute; top: -38px; left:50%; transform:translateX(-50%); white-space:nowrap; padding:6px 10px; background:#111827; border:1px solid rgba(255,255,255,.08); border-radius:10px; font-size:12px; color:#e5e7eb }
    /* Rescan progress */
    #rescanProgressWrap { display: none }
    #rescanProgressBar { height: 8px; border-radius: 999px; background: rgba(255,255,255,0.06); overflow:hidden }
    #rescanProgressBar > div { height: 100%; width: 0%; transition: width .2s linear; background: linear-gradient(90deg,#06b6d4,#3b82f6) }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-200">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-black/40 backdrop-blur border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-gradient-to-tr from-indigo-500 via-cyan-400 to-emerald-400 grid place-items-center font-black">M</div>
      <div>
        <h1 class="text-xl md:text-2xl font-bold tracking-tight">Monscription Indexer <span class="text-xs ml-2 align-middle px-2 py-0.5 rounded-full bg-white/10">Monad Testnet</span></h1>
        <p class="text-xs text-slate-400">Contract: <code id="contractLink" class="underline decoration-dotted cursor-pointer"></code></p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <a href="https://mons-mon-20.vercel.app/" target="_blank" class="btn btn-primary px-4 py-2 text-sm font-medium">Mint Portal</a>
        <button id="connectBtn" class="px-4 py-2 text-sm font-semibold bg-white/10 hover:bg-white/20 rounded-full">Connect Wallet</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 pt-8 pb-4">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="card glass p-5">
        <div class="text-slate-400 text-xs">Network</div>
        <div class="flex items-end gap-2 mt-1">
          <div class="text-2xl font-bold">Monad Testnet</div>
          <span id="chainBadge" class="badge text-xs px-2 py-1 rounded-full bg-white/5">Chain ID 10143</span>
        </div>
        <div class="mt-3 text-sm text-slate-400 break-all">RPC: <span id="rpcLink" class="underline decoration-dotted cursor-pointer"></span></div>
      </div>
      <div class="card glass p-5">
        <div class="text-slate-400 text-xs">First Token</div>
        <div class="text-2xl font-bold gradient-text">MONS</div>
        <div class="mt-1 text-sm text-slate-400"></div>
      </div>
      <div class="card glass p-5">
        <div class="flex items-center gap-2">
          <div class="text-slate-400 text-xs">Indexer Status</div>
          <span id="liveDot" class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
        </div>
        <div class="mt-2 text-2xl font-bold" id="blockHeight">—</div>
        <div class="text-sm text-slate-400">Synced up to latest block</div>
      </div>
    </div>
  </section>

  <!-- Controls -->
  <section class="max-w-7xl mx-auto px-4 pb-4 flex flex-col md:flex-row gap-3 md:items-center">
    <div class="flex items-center gap-2 glass p-2 rounded-2xl grow">
      <svg data-lucide="search" class="w-5 h-5 opacity-60"></svg>
      <input id="searchInput" class="bg-transparent focus:outline-none w-full" placeholder="Cari tick, deployer, address holder…" />
    </div>
    <div class="glass rounded-2xl p-2 flex items-center gap-2">
      <label class="text-sm text-slate-400">Dari blok</label>
      <input id="fromBlock" type="number" class="w-28 bg-white/5 rounded-lg px-2 py-1" placeholder="0" />
      <label class="text-sm text-slate-400">s/d</label>
      <input id="toBlock" type="number" class="w-28 bg-white/5 rounded-lg px-2 py-1" placeholder="latest" />
      <button id="rescanBtn" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-xl text-sm">Rescan</button>
    </div>
    <div class="glass rounded-2xl p-2 flex items-center gap-2">
      <button id="exportCsv" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-xl text-sm">Export CSV</button>
      <button id="exportJson" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-xl text-sm">Export JSON</button>
    </div>
  </section>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 pb-16 grid lg:grid-cols-3 gap-6">
    <!-- Tokens -->
    <section class="lg:col-span-2 card glass p-0 overflow-hidden">
      <div class="p-4 flex items-center justify-between border-b border-white/10">
        <div>
          <h2 class="text-lg font-semibold">Tokens Terindeks</h2>
          <div class="text-xs text-slate-400">Indexer Monscription</div>
        </div>
        <div class="flex gap-2 text-xs text-slate-400">
          <span id="tokenCount">0</span>
          <span>items</span>
        </div>
      </div>

      <!-- Rescan progress (hidden until rescan starts) -->
      <div id="rescanProgressWrap" class="p-3 border-b border-white/5">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs text-slate-400" id="rescanProgressText">Preparing…</div>
          <div class="text-xs text-slate-400" id="rescanProgressPct">0%</div>
        </div>
        <div id="rescanProgressBar"><div></div></div>
      </div>

      <div class="overflow-auto">
        <table class="w-full table-fixed">
          <thead class="text-slate-400 text-xs uppercase">
            <tr class="text-left">
              <th class="p-3 w-24">Tick</th>
              <th class="p-3">Max/Limit</th>
              <th class="p-3">Minted</th>
              <th class="p-3">Progress</th>
              <th class="p-3">Holders</th>
              <th class="p-3">Deployer</th>
              <th class="p-3 w-20">Aksi</th>
            </tr>
          </thead>
          <tbody id="tokenTbody" class="text-sm">
            <!-- rows injected here -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Live Inscribe Stream -->
    <aside class="card glass p-0 overflow-hidden">
      <div class="p-4 border-b border-white/10 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Live Inscribe</h2>
        <span id="inscribeCount" class="text-xs text-slate-400">0</span>
      </div>
      <div id="inscribeList" class="max-h-[640px] overflow-auto divide-y divide-white/5">
        <!-- items injected here -->
      </div>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-6 text-sm text-slate-400 flex flex-col md:flex-row gap-2 md:items-center">
      <div>
        © <span id="year"></span> Community is everything. Kredit: <a class="underline" target="_blank" href="https://x.com/ega_2ez4crypto">created by https://x.com/ega_2ez4crypto</a>
      </div>
      <div class="md:ml-auto flex items-center gap-3">
        <a class="underline" target="_blank" href="https://mons-mon-20.vercel.app/">Mint MONS</a>
        <a class="underline" target="_blank" id="etherscanLink">Explorer</a>
        <button id="copyJson" class="px-3 py-1 bg-white/5 rounded-lg">Salin Snapshot</button>
      </div>
    </div>
  </footer>

  <!-- Detail Modal -->
  <dialog id="detailModal" class="backdrop:bg-black/60 rounded-2xl w-full max-w-2xl p-0 bg-slate-900 text-slate-200 border border-white/10">
    <div class="p-5 border-b border-white/10 flex items-center justify-between">
      <div>
        <div class="text-sm text-slate-400">Detail Token</div>
        <div id="modalTick" class="text-2xl font-bold"></div>
      </div>
      <button onclick="closeModal()" class="px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-xl">Close</button>
    </div>
    <div class="p-5 grid md:grid-cols-2 gap-4">
      <div class="glass rounded-2xl p-4">
        <div class="text-sm text-slate-400">Info</div>
        <div id="modalInfo" class="mt-2 text-sm"></div>
      </div>
      <div class="glass rounded-2xl p-4">
        <div class="text-sm text-slate-400 mb-2">Top Holders (max 100)</div>
        <ol id="modalHolders" class="text-sm list-decimal list-inside space-y-1"></ol>
      </div>
    </div>
    <div class="p-5 border-t border-white/10 text-xs text-slate-400">Data langsung dari kontrak pada saat dibuka.</div>
  </dialog>

  <script>
    // ====== CONFIG ======
    const RPC_URL = 'https://testnet-rpc.monad.xyz';
    const CHAIN_ID = 10143; // Monad Testnet
    const CONTRACT_ADDRESS = '0x07169f0F890C3595421512D98DC79b8bce6E5fA6';
    const ABI = [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"string","name":"tick","type":"string"},{"indexed":false,"internalType":"uint256","name":"maxSupply","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"indexed":false,"internalType":"address","name":"deployer","type":"address"}],"name":"Deploy","type":"event"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"}],"name":"deployToken","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"string","name":"tick","type":"string"},{"indexed":false,"internalType":"string","name":"operation","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"data","type":"string"},{"indexed":false,"internalType":"uint256","name":"inscriptionNumber","type":"uint256"}],"name":"Inscribe","type":"event"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"setDeployFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"setMintFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"stateMutability":"payable","type":"receive"},
      {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"string","name":"","type":"string"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"deployFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"tick","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getHolders","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getHoldersCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getMintProgress","outputs":[{"internalType":"uint256","name":"minted","type":"uint256"},{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"percentage","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTokenInfo","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"internalType":"uint256","name":"minted","type":"uint256"},{"internalType":"address","name":"deployer","type":"address"},{"internalType":"uint256","name":"holdersCount","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTotalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"holders","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"inscriptionCounter","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"address","name":"","type":"address"}],"name":"isHolder","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"mintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"tokens","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"internalType":"address","name":"deployer","type":"address"},{"internalType":"bool","name":"exists","type":"bool"},{"internalType":"uint256","name":"deployedAt","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"totalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    // ====== GLOBALS ======
    const state = {
      provider: null,
      readonlyProvider: null,
      signer: null,
      contract: null,
      tokens: [], // {tick, maxSupply, limitPerMint, minted, holdersCount, deployer, deployedAt}
      inscribes: [], // latest first
      lastScannedBlock: 0,
      latestBlock: 0,
    };

    // ====== UTILS ======
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const fmt = (n)=> new Intl.NumberFormat('en-US').format(Number(n));
    const shortAddr = (a)=> a ? a.slice(0,6)+'…'+a.slice(-4) : '';

    function setExplorerLinks(){
      const base = 'https://explorer.monad.xyz'; // adjust if needed for testnet explorer
      const addrUrl = `${base}/address/${CONTRACT_ADDRESS}`;
      const rpcUrl = RPC_URL;
      $('#contractLink').textContent = CONTRACT_ADDRESS;
      $('#contractLink').onclick = ()=>window.open(addrUrl,'_blank');
      $('#rpcLink').textContent = rpcUrl;
      $('#rpcLink').onclick = ()=>window.open(rpcUrl,'_blank');
      $('#etherscanLink').href = addrUrl;
    }

    function progressBar(p){
      return `<div class="w-full bg-white/10 rounded-full overflow-hidden"><div class="h-2" style="width:${p}% ; background: linear-gradient(90deg,#22c55e,#3b82f6)"></div></div>`
    }

    function rowSkeleton(){
      return `<tr class="border-t border-white/5"><td colspan="7"><div class='p-3 skeleton h-8 rounded-lg'></div></td></tr>`
    }

    function download(filename, text){
      const a = document.createElement('a');
      a.setAttribute('href','data:text/plain;charset=utf-8,'+encodeURIComponent(text));
      a.setAttribute('download', filename);
      a.click();
    }

    function toCSV(rows){
      const headers = Object.keys(rows[0]||{});
      const esc = v => '"'+String(v).replace(/"/g,'""')+'"';
      const lines = [headers.join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h] ?? '')).join(',')));
      return lines.join('\n');
    }

    // ====== PROGRESS UI ======
    function showRescanProgress(){
      $('#rescanProgressWrap').style.display = 'block';
      $('#rescanProgressPct').textContent = '0%';
      $('#rescanProgressText').textContent = 'Starting rescan…';
      $('#rescanProgressBar > div').style.width = '0%';
    }
    function updateRescanProgress(done, total){
      const pct = total > 0 ? Math.round((done/total)*100) : 0;
      $('#rescanProgressPct').textContent = pct + '%';
      $('#rescanProgressText').textContent = `Processing ${done} / ${total} blocks`;
      $('#rescanProgressBar > div').style.width = pct + '%';
    }
    function hideRescanProgress(){
      $('#rescanProgressWrap').style.display = 'none';
    }

    // ====== RENDER ======
    function renderTokens(){
      const q = ($('#searchInput').value||'').toLowerCase().trim();
      const filtered = state.tokens.filter(t =>
        t.tick.toLowerCase().includes(q) ||
        (t.deployer||'').toLowerCase().includes(q)
      );
      $('#tokenCount').textContent = fmt(filtered.length);
      const tbody = $('#tokenTbody');
      tbody.innerHTML = '';
      for (const t of filtered){
        const perc = t.maxSupply > 0 ? Math.min(100, Number((Number(t.minted)/Number(t.maxSupply))*100).toFixed(2)) : 0;
        const tr = document.createElement('tr');
        tr.className = 'border-t border-white/5 hover:bg-white/5';
        tr.innerHTML = `
          <td class="p-3 font-semibold">${t.tick}</td>
          <td class="p-3">${fmt(t.maxSupply)} <span class='text-slate-500'>/</span> ${fmt(t.limitPerMint)}</td>
          <td class="p-3">${fmt(t.minted)}</td>
          <td class="p-3">${progressBar(perc)}<div class='text-xs text-slate-400 mt-1'>${perc}%</div></td>
          <td class="p-3">${fmt(t.holdersCount)}</td>
          <td class="p-3"><span class='tooltip underline decoration-dotted' data-tip='${t.deployer}'>${shortAddr(t.deployer)}</span></td>
          <td class="p-3">
            <button class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded-xl text-xs" data-tick="${t.tick}">Detail</button>
          </td>`;
        tr.querySelector('button').addEventListener('click', ()=>openModal(t.tick));
        tbody.appendChild(tr);
      }
      if (!filtered.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" class="p-6 text-center text-slate-500">Belum ada token terindeks pada rentang blok ini.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderInscribe(){
      const box = $('#inscribeList');
      box.innerHTML = '';
      for (const e of state.inscribes.slice(0,200)){
        const div = document.createElement('div');
        div.className = 'p-4 hover:bg-white/5';
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm"><span class="px-2 py-0.5 rounded-full bg-white/10 mr-2">${e.tick}</span> ${e.operation} <span class="text-slate-400">${fmt(e.amount)}</span></div>
            <div class="text-xs text-slate-400">#${e.blockNumber} · ${dayjs(e.time*1000).fromNow()}</div>
          </div>
          <div class="text-xs text-slate-400 mt-1">by <span class='underline decoration-dotted tooltip' data-tip='${e.user}'>${shortAddr(e.user)}</span> • insc#${e.inscriptionNumber} • ${e.data || ''}</div>
        `;
        box.appendChild(div);
      }
      $('#inscribeCount').textContent = fmt(state.inscribes.length);
    }

    async function openModal(tick){
      $('#modalTick').textContent = tick;
      $('#modalInfo').innerHTML = 'Loading…';
      $('#modalHolders').innerHTML = '';
      detailModal.showModal();
      try{
        const c = state.contract;
        const info = await c.getTokenInfo(tick);
        const minted = info.minted.toString();
        const maxSupply = info.maxSupply.toString();
        const holdersCount = info.holdersCount.toString();
        const deployer = info.deployer;
        $('#modalInfo').innerHTML = `
          <div>Max Supply: <b>${fmt(maxSupply)}</b></div>
          <div>Limit / Mint: <b>${fmt(info.limitPerMint.toString())}</b></div>
          <div>Minted: <b>${fmt(minted)}</b></div>
          <div>Holders: <b>${fmt(holdersCount)}</b></div>
          <div>Deployer: <a class='underline decoration-dotted' target='_blank' href='https://explorer.monad.xyz/address/${deployer}'>${shortAddr(deployer)}</a></div>
        `;
        let holders = [];
        try { holders = await c.getHolders(tick); } catch(e){ console.warn('getHolders failed', e); }
        const list = $('#modalHolders');
        holders.slice(0,100).forEach((h,i)=>{
          const li = document.createElement('li');
          li.innerHTML = `<a class='underline' target='_blank' href='https://explorer.monad.xyz/address/${h}'>${h}</a>`;
          list.appendChild(li);
        });
        if (!holders.length){ list.innerHTML = '<div class="text-slate-500">Tidak ada data holders (belum ada mint / RPC membatasi).</div>'; }
      }catch(err){
        console.error(err);
        $('#modalInfo').innerHTML = '<span class="text-red-400">Gagal memuat detail.</span>';
      }
    }
    function closeModal(){ detailModal.close(); }

    // ====== INDEXER CORE ======
    async function initProviders(){
      state.readonlyProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
      state.provider = state.readonlyProvider;
      state.contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, state.provider);
    }

    async function connectWallet(){
      if (!window.ethereum){ alert('Wallet tidak ditemukan. Install MetaMask/Frame.'); return; }
      const [acc] = await window.ethereum.request({ method:'eth_requestAccounts' });
      const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
      const net = await web3Provider.getNetwork();
      if (Number(net.chainId) !== CHAIN_ID){
        try{
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x'+CHAIN_ID.toString(16) }]
          });
        }catch(switchErr){
          if (switchErr.code === 4902){
            await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{
              chainId: '0x'+CHAIN_ID.toString(16),
              chainName: 'Monad Testnet',
              rpcUrls: [RPC_URL],
              nativeCurrency: { name:'tMON', symbol:'tMON', decimals:18 },
              blockExplorerUrls: ['https://explorer.monad.xyz']
            }]});
          } else { throw switchErr; }
        }
      }
      state.provider = web3Provider;
      state.signer = web3Provider.getSigner();
      state.contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, state.provider);
      $('#connectBtn').textContent = shortAddr(acc);
    }

    async function getLatestBlock(){
      state.latestBlock = await state.provider.getBlockNumber();
      $('#blockHeight').textContent = '#'+fmt(state.latestBlock);
      return state.latestBlock;
    }

    /**
     * Fetch logs in batches to avoid RPC limits (Monad testnet limits eth_getLogs to small ranges)
     * filterObj should be a standard ethers filter (address + topics)
     */
    async function fetchLogsInBatches(filterObj, fromBlock, toBlock, batchSize = 100, onProgress){
      const provider = state.provider;
      const totalBlocks = Math.max(0, toBlock - fromBlock + 1);
      let processedBlocks = 0;
      const allLogs = [];

      // defensive: ensure integers
      fromBlock = Number(fromBlock);
      toBlock = Number(toBlock);

      for (let start = fromBlock; start <= toBlock; start += batchSize){
        let end = Math.min(toBlock, start + batchSize - 1);
        try{
          const logs = await provider.getLogs({ ...filterObj, fromBlock: start, toBlock: end });
          allLogs.push(...logs);
        }catch(err){
          const msg = String(err?.message || err);
          console.warn('batch failed', start, end, msg);
          // If RPC complains about range, reduce batch and retry this range recursively with half-size
          if (batchSize > 1 && /limited to|range/i.test(msg)){
            const half = Math.max(1, Math.floor(batchSize/2));
            const nested = await fetchLogsInBatches(filterObj, start, end, half, onProgress);
            allLogs.push(...nested);
          } else {
            // Non-recoverable — rethrow to let caller handle
            throw err;
          }
        }
        processedBlocks += (end - start + 1);
        if (typeof onProgress === 'function') onProgress(processedBlocks, totalBlocks);
        // small delay to avoid hitting rate limits
        await new Promise(r => setTimeout(r, 120));
      }
      return allLogs;
    }

    async function scanDeploys(from, to){
      const c = state.contract;
      const iface = c.interface;
      const filter = c.filters.Deploy();
      const logs = await fetchLogsInBatches(filter, from, to, 100, updateRescanProgress);
      const found = new Map();
      for (const l of logs){
        try{
          const parsed = iface.parseLog(l);
          const tick = parsed.args.tick;
          found.set(tick, { tick, maxSupply: parsed.args.maxSupply.toString(), limitPerMint: parsed.args.limitPerMint.toString(), deployer: parsed.args.deployer, deployedAt: l.blockNumber });
        }catch(e){ console.warn('parse deploy log failed', e); }
      }
      return Array.from(found.values());
    }

    async function enrichToken(t){
      try{
        const info = await state.contract.getTokenInfo(t.tick);
        t.maxSupply = info.maxSupply.toString();
        t.limitPerMint = info.limitPerMint.toString();
        t.minted = info.minted.toString();
        t.deployer = info.deployer;
        t.holdersCount = info.holdersCount.toString();
      }catch(e){ console.warn('getTokenInfo fail', t.tick, e); }
      return t;
    }

    async function scanInscribes(from, to){
      const c = state.contract;
      const iface = c.interface;
      const filter = c.filters.Inscribe();
      const logs = await fetchLogsInBatches(filter, from, to, 100, updateRescanProgress);
      const events = [];
      for (const l of logs){
        try{
          const p = iface.parseLog(l);
          // get block timestamp (may be multiple calls)
          let block;
          try { block = await state.provider.getBlock(l.blockNumber); } catch(e){ block = { timestamp: Math.floor(Date.now()/1000) }; }
          events.push({
            blockNumber: l.blockNumber,
            user: p.args.user,
            tick: p.args.tick,
            operation: p.args.operation,
            amount: p.args.amount.toString(),
            data: p.args.data,
            inscriptionNumber: p.args.inscriptionNumber.toString(),
            time: block.timestamp
          });
        }catch(e){ console.warn('parse inscribe log failed', e); }
      }
      events.sort((a,b)=>b.blockNumber - a.blockNumber);
      return events;
    }

    async function rescan(){
      try{
        const latest = await getLatestBlock();
        let from = Number($('#fromBlock').value || 0);
        let to = Number($('#toBlock').value || latest);
        if (from > to) { const tmp = from; from = to; to = tmp; }

        // show skeleton and progress UI
        $('#tokenTbody').innerHTML = rowSkeleton()+rowSkeleton()+rowSkeleton();
        showRescanProgress();
        updateRescanProgress(0, Math.max(0, to - from + 1));

        // Scan Deploy events (batched)
        const baseTokens = await scanDeploys(from, to);

        // Ensure MONS exists if present in mapping
        try {
          if (!baseTokens.find(t=>t.tick==='MONS')){
            const tk = await state.contract.tokens('MONS');
            if (tk && tk.exists){ baseTokens.push({ tick:'MONS', maxSupply: tk.maxSupply.toString(), limitPerMint: tk.limitPerMint.toString(), deployer: tk.deployer, deployedAt: tk.deployedAt.toNumber?.() || tk.deployedAt }); }
          }
        }catch(e){ console.warn('tokens("MONS") fallback failed', e); }

        // Enrich tokens (sequentially)
        const enriched = [];
        for (const t of baseTokens){
          enriched.push(await enrichToken(t));
        }
        enriched.sort((a,b)=> (b.deployedAt||0) - (a.deployedAt||0));
        state.tokens = enriched;
        renderTokens();

        // Scan Inscribe events (batched)
        state.inscribes = await scanInscribes(from, to);
        renderInscribe();

        state.lastScannedBlock = to;
        hideRescanProgress();
      }catch(err){
        console.error(err);
        hideRescanProgress();
        alert('Rescan gagal: '+(err?.message||err));
      }
    }

    async function liveSubscribe(){
      // Update latest block indicator
      state.provider.on('block', async (bn)=>{
        state.latestBlock = bn;
        $('#blockHeight').textContent = '#'+fmt(bn);
      });
      // Live Deploy
      state.contract.on('Deploy', async (tick, maxSupply, limitPerMint, deployer, ev)=>{
        const t = await enrichToken({ tick, maxSupply: maxSupply.toString(), limitPerMint: limitPerMint.toString(), deployer, deployedAt: ev.blockNumber, minted:'0', holdersCount:'0' });
        const i = state.tokens.findIndex(x=>x.tick===t.tick);
        if (i>=0) state.tokens[i]=t; else state.tokens.unshift(t);
        renderTokens();
      });
      // Live Inscribe
      state.contract.on('Inscribe', async (user, tick, operation, amount, data, inscriptionNumber, ev)=>{
        try{
          const block = await state.provider.getBlock(ev.blockNumber);
          state.inscribes.unshift({ blockNumber: ev.blockNumber, user, tick, operation, amount: amount.toString(), data, inscriptionNumber: inscriptionNumber.toString(), time: block.timestamp });
          renderInscribe();
          // Also refresh the token row minted + holders
          const idx = state.tokens.findIndex(t=>t.tick===tick);
          if (idx>=0){
            try{
              const info = await state.contract.getTokenInfo(tick);
              state.tokens[idx].minted = info.minted.toString();
              state.tokens[idx].holdersCount = info.holdersCount.toString();
              renderTokens();
            }catch(e){ console.warn('refresh token after inscribe failed', e); }
          }
        }catch(e){ console.warn('live inscribe enrich failed', e); }
      });
    }

    // ====== EXPORT SNAPSHOT ======
    function exportSnapshot(){
      return {
        contract: CONTRACT_ADDRESS,
        chainId: CHAIN_ID,
        rpc: RPC_URL,
        block: state.latestBlock,
        tokens: state.tokens,
        inscribes: state.inscribes.slice(0,1000)
      };
    }

    // ====== BOOT ======
    async function boot(){
      setExplorerLinks();
      $('#year').textContent = new Date().getFullYear();
      lucide.createIcons();
      await initProviders();
      await getLatestBlock();
      await rescan();
      liveSubscribe();
    }

    // ====== EVENTS ======
    $('#rescanBtn').addEventListener('click', rescan);
    $('#searchInput').addEventListener('input', renderTokens);
    $('#connectBtn').addEventListener('click', connectWallet);
    $('#exportCsv').addEventListener('click', ()=>{
      if (!state.tokens.length) return alert('Tidak ada data.');
      const csv = toCSV(state.tokens);
      download('monscription_tokens.csv', csv);
    });
    $('#exportJson').addEventListener('click', ()=>{
      const json = JSON.stringify(exportSnapshot(), null, 2);
      download('monscription_snapshot.json', json);
    });
    $('#copyJson').addEventListener('click', ()=>{
      navigator.clipboard.writeText(JSON.stringify(exportSnapshot()));
      alert('Snapshot disalin ke clipboard.');
    });

    // Start
    boot();
  </script>
</body>
</html>


